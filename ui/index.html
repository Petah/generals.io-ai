<!doctype html>
<html ng-app="App">
    <head>
        <title>My AngularJS App</title>
        <script src="../bower_components/tinycolor/tinycolor.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.6/angular.js"></script>
        <style>
            * {

                box-sizing: border-box;
            }

            html,
            body {
                display: flex;
                margin: 0;
                padding: 0;
                width: 100%;
                height: 100%;
                font-family: monospace;
            }

            body {
                display: flex;
                flex-direction: column;
            }

            .zx-toolbar {
                text-align: center;
            }

            .zx-grid {
                display: flex;
                flex-direction: column;
                flex: 1;
            }

            .zx-grid-row {
                display: flex;
                flex: 1;
            }

            .zx-ai {
                display: flex;
                flex-direction: column;
                flex: 1;
                border: 1px solid #ddd;
                position: relative;
            }

            .zx-row {
                display: flex;
                flex: 1;
            }

            .zx-cell {
                flex: 1;
                display: flex;
                justify-content: center;
                flex-direction: column;
                text-align: center;
            }

            .zx-cell-text {
            }

            .zx-cell-empty {
                background-color: #fff;
            }

            .zx-cell-mountain {
                background-color: #333;
            }

            .zx-cell-fog {
                background-color: #aaa;
            }

            .zx-cell-fog-obstacle {
                background-color: #999;
            }

            .zx-cell-city {
                background-color: #8e44ad;
                box-shadow:inset 0px 0px 0px 2px #8e44ad;
            }

            .zx-cell-general {
                text-decoration: underline;
                box-shadow:inset 0px 0px 0px 2px #2c3e50;
            }

            .zx-cell-color-0 {
                background-color: #3498db;
            }

            .zx-cell-color-1 {
                background-color: #e74c3c;
            }

            .zx-cell-color-2 {
                background-color: #2ecc71;
            }

            .zx-cell-color-3 {
                background-color: #f1c40f;
            }

            .zx-overlay {
                position: absolute;
                top: 0;
                right: 0;
                background-color: rgba(128, 128, 128, 0.5);
            }
        </style>
    </head>
    <body ng-controller="AppController" ng-cloak>
        <div class="zx-toolbar">
            <button ng-click="start()">Start</button>
            <button ng-click="stop()">Stop</button>
        </div>
        <div class="zx-grid" ng-if="ais.length == 1">
            <div class="zx-grid-row">
                <div zx-ai="ais[0]" class="zx-ai"></div>
            </div>
        </div>
        <div class="zx-grid" ng-if="ais.length > 1">
            <div class="zx-grid-row">
                <div zx-ai="ais[0]" class="zx-ai"></div>
                <div zx-ai="ais[1]" class="zx-ai"></div>
            </div>
            <div class="zx-grid-row">
                <div zx-ai="ais[2]" class="zx-ai"></div>
                <div zx-ai="ais[3]" class="zx-ai"></div>
            </div>
        </div>
        <script>
            var app = angular.module('App', []);
            var queue = [];
            var combineState = function(ai, others) {
                ai = angular.copy(others[0], {});
                delete ai.log;
                for (var i = 1; i < others.length; i++) {
                    for (var r = 0; r < ai.height; r++) {
                        for (var c = 0; c < ai.width; c++) {
                            if (others[i] && others[i].replayUrl == ai.replayUrl) {
                                if (others[i].rows[r][c].armies > ai.rows[r][c].armies) {
                                    ai.rows[r][c].armies = others[i].rows[r][c].armies;
                                    ai.rows[r][c].playerIndex = others[i].rows[r][c].playerIndex;
                                    ai.rows[r][c].terrain = others[i].rows[r][c].terrain;
                                } else if (ai.rows[r][c].terrain < -2 && others[i].rows[r][c].terrain >= -2) {
                                    ai.rows[r][c].terrain = others[i].rows[r][c].terrain;
                                }
                                if (ai.rows[r][c].cities < 0 && others[i].rows[r][c].cities >= -1) {
                                    ai.rows[r][c].cities = others[i].rows[r][c].cities;
                                }
                            }
                        }
                    }
                }
                return ai;
            };

            app.controller('AppController', function($scope, $http, $interval) {
                let started = true;
                var updateAi = function() {
                    $http({
                        url: '../data/ais.json',
                        params: {
                            date: new Date().getTime(),
                        },
                    }).then(function(response) {
                        $scope.ais = response.data;
                        if ($scope.ais.length > 1) {
                            $scope.ais[3] = combineState($scope.ai3, [$scope.ais[0], $scope.ais[1], $scope.ais[2]]);
                        }
                        queue.push({});
                    });
                };
                $scope.ais = [];
                updateAi();
                $interval(function() {
                    if (!started) {
                        return;
                    }
                    if (queue.length) {
                        var next = queue.shift();
                        updateAi();
                    }
                }, 450);

                $scope.stop = function() {
                    started = false;
                };

                $scope.start = function() {
                    started = true;
                };
            });
            app.filter('reverse', function() {
                return function(items) {
                    if (items) {
                        return items.slice().reverse();
                    }
                    return items;
                };
            });
            app.filter('join', function() {
                return function(items) {
                    if (items) {
                        return items.join(' ');
                    }
                    return items;
                };
            });
            app.directive('zxAi', function() {
                return {
                    scope: {
                        ai: '=zxAi',
                    },
                    template: `
                        <div ng-repeat="row in ai.rows" class="zx-row">
                            <div ng-repeat="col in row track by $index" class="zx-cell" title="{{ col.x }} {{ col.y }}" ng-class="{
                                'zx-cell-empty': col.terrain == -1,
                                'zx-cell-mountain': col.terrain == -2,
                                'zx-cell-fog': col.terrain == -3,
                                'zx-cell-fog-obstacle': col.terrain == -4,
                                'zx-cell-city': col.cities >= 0,
                                'zx-cell-general': col.general >= 0,
                                'zx-cell-color-0': col.terrain == 0,
                                'zx-cell-color-1': col.terrain == 1,
                                'zx-cell-color-2': col.terrain == 2,
                                'zx-cell-color-3': col.terrain == 3,
                            }" ng-style="{
                                backgroundColor: getColor(ai, col),
                            }">
                                <div class="zx-cell-text">
                                    {{ col.terrain == -1 ? '' : '' }}
                                    {{ col.terrain == -2 ? 'M' : '' }}
                                    {{ col.terrain == -3 ? '' : '' }}
                                    {{ col.terrain == -4 ? 'O' : '' }}
                                    {{ col.armies > 0 ? col.armies : '' }}
                                </div>
                            </div>
                        </div>
                        <div class="zx-overlay">
                            <div ng-repeat="message in ai.chat">{{ message[1].text }}</div>
                            <div><a href="{{ ai.replayUrl }}" target="_blank">Replay</a></div>
                            <div>Turn {{ ai.turn }}</div>
                            <div>Min {{ ai.minArmies }}</div>
                            <div>Max {{ ai.maxArmies }}</div>
                            <div ng-repeat="score in ai.scores">{{ score.tiles }} {{ score.total }} {{ ai.usernames[$index] }}</div>
                            <div ng-repeat="log in formatLog(ai.log) track by $index">{{ log }}</div>
                        </div>
                    `,
                    link: function(scope, element, attributes) {
                        scope.formatLog = (log) => {
                            if (log) {
                                return log.slice().reverse().map(line => line.join(' '));
                            }
                        };

                        const colors = [
                            '#3498db',
                            '#e74c3c',
                            '#2ecc71',
                            '#f1c40f',
                        ];

                        scope.getColor = (ai, col) => {
                            switch (col.terrain) {
                                case -4: return '#999';
                                case -3: return '#aaa';
                                case -2: return '#444';
                                case -1: return '#fff';
                            }
                            let hex = colors[col.terrain];
                            let color = tinycolor(hex).toRgb();
                            let alpha = col.armies / ai.maxArmies;
                            return `rgba(${color.r}, ${color.g}, ${color.b}, ${alpha})`;
                        };
                    },
                };
            });
        </script>
    </body>
</html>
